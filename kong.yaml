_format_version: "2.1"

services:
  - name: personal_medico
    host: medico_upstream
    protocol: http
    routes:
      - name: personal-medico-internal
        paths:
          - /personal-medico/internal
        strip_path: false
      - name: personal-medico-internal-assignments
        paths:
          - /personal-medico/internal/assignments
        strip_path: false
        # Para Core de seguridad
      - name: personal-medico-status
        paths:
          - /personal-medico/status # Kong recibirá /personal-medico/status
        strip_path: true           # Kong enviará /status a Django
      - name: personal-medico-spoofed-status
        paths:
          - /personal-medico/spoofed-status # Kong recibirá /personal-medico/spoofed-status
        strip_path: true                     # Kong enviará /spoofed-status a Django


  - name: historia_clinica
    host: historia_clinica_upstream
    protocol: http
    routes:
      - name: historia_clinica
        host: historia_clinica_upstream
        protocol: http
        routes:
      - name: historia-clinica-bulk-create
        paths:
          - /historia-clinica/internal/diagnoses/bulk_create
        strip_path: false
      - name: historia-clinica-report
        paths:
          - /historia-clinica/api/report
        strip_path: false

      # PAra Core de seguridad
      - name: historia-clinica-status
        paths:
          - /historia-clinica/status
        strip_path: true
      - name: historia-clinica-spoofed-status
        paths:
          - /historia-clinica/spoofed-status
        strip_path: true

   # NUEVO: Microservicio de Seguridad Java
  - name: seguridad_ms 
    host: seguridad_upstream 
    protocol: http
    routes:
      - name: seguridad-route # Ruta para acceder al microservicio de seguridad
        paths:
          - /seguridad # Este será el path que tu UI llamará a través de Kong 
        strip_path: true # Quita '/seguridad' antes de reenviar al microservicio Java
    plugins: # <--- ¡AÑADE ESTA SECCIÓN PARA EL PLUGIN CORS!
      - name: cors
        config:
          # ¡IMPORTANTE! Aquí se especifica la IP externa de tu UI
          origins:
            - http://34.9.134.78 # <-- ¡Esta es la IP de tu msd-seguridad-ui-ms!
          methods:
            - GET
            - POST
            - PUT
            - DELETE
          headers:
            - Accept
            - Accept-Language
            - Content-Language
            - Content-Type
          exposed_headers: []
          credentials: true
          max_age: 3600
          preflight_continue: true

upstreams:
  - name: medico_upstream
    targets:
      - target: 10.128.0.84:8080
        weight: 100

  - name: historia_clinica_upstream
    targets:
      - target: 10.128.0.85:8080
        weight: 100

  - name: seguridad_upstream
    targets:
      - target: 10.128.0.86:8081
        weight: 100